name: Convert Markdown to PDF

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.md'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the workflow with debug logging'
        required: false
        default: false
        type: boolean

jobs:
  convert_to_pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Required to get all history for proper commit messages

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic

      - name: Find modified markdown files
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          files: |
            **/*.md

      - name: List changed files (debug)
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Convert Markdown to PDF
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ $file == *.md ]]; then
              echo "Converting $file to PDF"
              # Create directory for the PDF if it doesn't exist
              mkdir -p "$(dirname "${file%.*}.pdf")"
              # Convert markdown to PDF using pandoc with PDF engine
              pandoc "$file" \
                -o "${file%.*}.pdf" \
                --pdf-engine=xelatex \
                -V geometry:margin=1in \
                -V documentclass=article \
                -V colorlinks=true \
                -V urlcolor=blue \
                --toc
              
              # Debug: Check if PDF was created
              if [ -f "${file%.*}.pdf" ]; then
                echo "✅ Successfully created ${file%.*}.pdf"
              else
                echo "❌ Failed to create ${file%.*}.pdf"
              fi
            fi
          done
          
          # Debug: List all PDFs in repository
          echo "Listing all PDF files:"
          find . -name "*.pdf" -type f

      - name: Commit PDF files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Use find to add PDFs instead of wildcard
          find . -name "*.pdf" -type f -exec git add {} \;
          
          # Try to commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Generate PDFs from markdown files"
            git push
          fi
